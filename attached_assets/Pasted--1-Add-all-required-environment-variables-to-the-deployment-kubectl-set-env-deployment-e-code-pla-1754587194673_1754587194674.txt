 # 1. Add all required environment variables to the deployment
kubectl set env deployment/e-code-platform \
  DATABASE_URL="postgresql://postgres:postgres@postgres:5432/ecode" \
  OPENAI_API_KEY="$OPENAI_API_KEY" \
  STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" \
  VITE_STRIPE_PUBLIC_KEY="$VITE_STRIPE_PUBLIC_KEY" \
  NODE_ENV="production" \
  PORT="5000" \
  SESSION_SECRET="your-secure-session-secret-here" \
  -n e-code-platform

# 2. Restart the deployment
kubectl rollout restart deployment/e-code-platform -n e-code-platform

# 3. Watch the rollout
kubectl rollout status deployment/e-code-platform -n e-code-platform

# 4. Check pods
kubectl get pods -n e-code-platform

# 5. View logs
kubectl logs -n e-code-platform deployment/e-code-platform --tail=50

# 6. Test the endpoints
curl http://35.189.194.33/api/monitoring/health
curl http://35.189.194.33/
deployment.apps/e-code-platform env updated
deployment.apps/e-code-platform restarted
Waiting for deployment spec update to be observed...
Waiting for deployment "e-code-platform" rollout to finish: 0 out of 1 new replicas have been updated...
Waiting for deployment "e-code-platform" rollout to finish: 0 out of 1 new replicas have been updated...
Waiting for deployment "e-code-platform" rollout to finish: 0 out of 1 new replicas have been updated...
Waiting for deployment "e-code-platform" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "e-code-platform" rollout to finish: 1 old replicas are pending termination...
deployment "e-code-platform" successfully rolled out
NAME                               READY   STATUS        RESTARTS      AGE
e-code-platform-6c787668fc-8d5cv   1/1     Running       0             3s
e-code-platform-6f499c46b7-hpfxd   1/1     Terminating   4 (48s ago)   2m28s
e-code-platform-f7455d668-7hlwq    0/1     Error         0             4s
postgres-5fb6b6654c-pt6f6          1/1     Running       0             77m
Found 3 pods, using pod/e-code-platform-6c787668fc-8d5cv

> rest-express@1.0.0 dev
> NODE_ENV=development tsx server/index.ts
